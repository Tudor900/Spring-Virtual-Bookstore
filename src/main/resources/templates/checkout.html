<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookstore - Checkout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
        --primary-color: #5d5dff;
        --primary-dark: #4b4bb2;
        --secondary-color: #f0f4f8;
        --text-color: #2c3e50;
        --card-background: #ffffff;
        --border-color: #e0e6ed;
        --shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        --transition: all 0.2s ease-in-out;
    }

    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        background-color: var(--secondary-color);
        color: var(--text-color);
        line-height: 1.6;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        padding: 20px;
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    .header h2 {
        margin: 0;
        font-size: 2rem;
        color: var(--primary-color);
        font-weight: 700;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid var(--primary-color);
        background-color: var(--primary-color);
        color: var(--card-background);
    }

    .btn:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background-color: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-secondary:hover {
        background-color: var(--primary-color);
        color: var(--card-background);
    }

    .btn-danger {
        background-color: #e74c3c;
        border-color: #e74c3c;
    }

    .btn-danger:hover {
        background-color: #c0392b;
        border-color: #c0392b;
    }

    .table-container {
        background-color: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .cart-table, .user-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .cart-table th, .cart-table td,
    .user-table th, .user-table td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .cart-table th, .user-table th {
        background-color: var(--primary-color);
        color: var(--card-background);
        font-weight: 500;
        text-transform: uppercase;
    }

    .cart-table tr:nth-child(even),
    .user-table tr:nth-child(even) {
        background-color: var(--secondary-color);
    }

    .cart-table tr:hover,
    .user-table tr:hover {
        background-color: var(--border-color);
    }

    .quantity-input {
        width: 60px;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-align: center;
        font-size: 1rem;
        transition: var(--transition);
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(93, 93, 255, 0.2);
    }

    .action-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>Your Shopping Cart</h2>
  </div>

  <div class="table-container">
    <table class="cart-table">
      <thead>
      <tr>
        <th>Title</th>
        <th>ISBN</th>
        <th>Author</th>
        <th>Current Quantity</th>
        <th>Change Quantity</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="book:${cartBooks}">
        <td th:text="${book.title}"></td>
        <td th:text="${book.isbn}"></td>
        <td th:text="${book.author.firstname} + ' ' + ${book.author.lastname}"></td>
        <td th:text="${cartItems.get(T(java.lang.String).valueOf(book.bookID))}"></td>
        <td>
          <input type="number"
                 class="quantity-input"
                 th:data-book-id="${book.bookID}"
                 min="1"
                 size="1"
                 th:value="${cartItems.get(T(java.lang.String).valueOf(book.bookID))}">
        </td>
        <td>
          <button class="btn btn-danger remove-item" th:data-book-id="${book.bookID}">Remove</button>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="action-container">
    <a th:href="@{/}" class="btn">Back to Books</a>
    <button id="update-checkout-btn" class="btn btn-secondary">Update Checkout</button>
  </div>

  <div class="header">
    <h2>Shipping Information</h2>
  </div>

  <div class="table-container">
    <table class="user-table">
      <thead>
      <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Address</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td th:text="${customer.firstname}"></td>
        <td th:text="${customer.lastname}"></td>
        <td th:text="${customer.address}"></td>
      </tr>
      </tbody>
    </table>
  </div>

  <form th:action="@{/sendorder}" th:method="post" style="text-align: center;">
    <button type="submit" class="btn">Send Order</button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const updateCheckoutBtn = document.getElementById('update-checkout-btn');
      const quantityInputs = document.querySelectorAll('.quantity-input');
      const removeButtons = document.querySelectorAll('.remove-item');

      function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) {
              return decodeURIComponent(parts.pop().split(';').shift());
          }
      }

      function setCookie(name, value, days) {
          let expires = "";
          if (days) {
              const date = new Date();
              date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
              expires = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + (encodeURIComponent(value) || "")  + expires + "; path=/";
      }

      function updateCartCookie(bookId, newQuantity) {
          let cart = {};
          const cookieValue = getCookie('shoppingCart');
          if (cookieValue) {
              cart = JSON.parse(cookieValue);
          }

          if (newQuantity > 0) {
              cart[bookId] = newQuantity;
          } else {
              delete cart[bookId];
          }

          setCookie('shoppingCart', JSON.stringify(cart), 3650);
      }

      quantityInputs.forEach(input => {
          input.addEventListener('change', (event) => {
              const bookId = event.target.dataset.bookId;
              const newQuantity = parseInt(event.target.value);
              if (newQuantity >= 1) {
                  updateCartCookie(bookId, newQuantity);
                  console.log(`Updated quantity for book ${bookId} to ${newQuantity}`);
              }
          });
      });

      removeButtons.forEach(button => {
          button.addEventListener('click', (event) => {
              const bookId = event.target.dataset.bookId;
              updateCartCookie(bookId, 0);
              const row = event.target.closest('tr');
              if (row) {
                  row.remove();
              }
              console.log(`Removed book ${bookId} from cart.`);
          });
      });

      updateCheckoutBtn.addEventListener('click', () => {
          window.location.reload();
      });
  });
</script>

</body>
</html>